stages:
  # # This stage is initially generated by:
  # dvc stage add -n julia_generate_csv_qrcode -o img/QRCode -o data/QRCode julia --project=@. scripts/generate_qrcode.jl
  # Referring: https://dvc.org/doc/command-reference/stage/add
  julia_generate_csv_qrcode:
    cmd: julia --project=@. scripts/generate_qrcode.jl
    outs:
      - data/QRCode
      - img/QRCode
  typst_compile:
    # # This stage is added by
    # dvc stage add -n typst_compile -d img/QRCode -d data/QRCode typst compile test_reply_sheet.typ
    cmd: typst compile test_reply_sheet.typ
    deps:
      - data/QRCode
      - img/QRCode
  generate_qrcode_group_score:
    cmd: julia --project=@. scripts/generate_qrcode_group_score.jl
    deps:
      - student_information.csv
      - scripts/generate_qrcode_group_score.jl
    outs:
      - data/group_qrcode_links.csv
      - img/QRCode_InterGroupLinks:
          persist: true
  typst_qrcode_group:
    cmd: typst compile group_score_fill.typ
    deps:
      - data/group_qrcode_links.csv
      - group_score_fill.typ
  update_quiz_score:
    # https://dvc.org/doc/user-guide/project-structure/dvcyaml-files#templating
    # dvc stage add -n update_quiz_score -p this_test -o data/quiz_score.csv julia --project=@. scripts/update_quiz_score.jl
    cmd: julia --project=@. scripts/update_quiz_score.jl ${this_test}
    params:
      - this_test
  send_quiz_score:
    # dvc stage add -n send_quiz_score -p this_test -d data/quiz_score.csv julia --project=@. scripts/send_quiz_score.jl
    # KEYNOTE: issent.csv will be modified.
    # CHECKPOINT: Set params.yaml, enable `do_send_email` and run `dvc repro`
    cmd: julia --project=@. scripts/send_quiz_score.jl ${this_test}
    deps:
      - data/quiz_score.csv
    params:
      - this_test
  update_group_scores:
    cmd: julia --project=@. scripts/update_group.jl
    outs:
      - data/innergroup_score.csv
      - data/intergroup_score.csv
    always_changed: true
  send_group_score:
    cmd: julia --project=@. scripts/send_group_score.jl
    deps:
      - data/innergroup_score.csv
      - data/intergroup_score.csv
    always_changed: true
